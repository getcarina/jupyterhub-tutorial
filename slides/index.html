<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>JupyterHub on Docker Swarm</title>

    <meta name="description" content="Deploy an interactive data science environment with JupyterHub on Docker Swarm">
    <meta name="author" content="Kyle Kelley">
    <meta name="author" content="Carolyn Van Slyck">
    <meta name="author" content="Everett Toews">
    <meta name="author" content="Ash Wilson">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/night.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section id="welcome">
          <h4>Deploy an interactive data science environment</h4>
          <h5>with JupyterHub on Docker Swarm</h5>
          <img src="img/docker-swarm.png"/>
          <h4><a href="http://rack.to/jupyterhub-on-docker-swarm">rack.to/jupyterhub-on-docker-swarm</a></h4>
          <p style="font-size: 50%;">Use the arrow keys to navigate</p>
        </section>

        <section id="instructors">
          <h3>Instructors</h3>
          <center>
            <table>
              <tbody>
                <tr>
                  <td>Kyle Kelley</td>
                  <td><a href="https://twitter.com/rgbkrk" target="_blank">@rgbkrk</a></td>
                </tr>
                <tr>
                  <td>Carolyn Van Slyck</td>
                  <td><a href="https://twitter.com/carolynvs" target="_blank">@carolynvs</a></td>
                </tr>
                <tr>
                  <td>Everett Toews</td>
                  <td><a href="https://twitter.com/everett_toews" target="_blank">@everett_toews</a></td>
                </tr>
                <tr>
                  <td>Ash Wilson</td>
                  <td><a href="https://twitter.com/smashwilson" target="_blank">@smashwilson</a></td>
                </tr>
              </tbody>
            </table>
          </center>
        </section>

        <section id="goals">
          <h3>Goals</h3>
          <p>Learn Docker basics and Docker Swarm fundamentals. To exercise these fundamentals the participants will deploy JupyterHub on <a href="https://getcarina.com/" target="_blank">Carina</a>, a hosted Docker Swarm environment. Along the way they'll also gain a better understanding of Jupyter, an open source web application that allows you to create and share documents that contain live code, equations, visualizations, and explanatory text.</p>
          <aside class="notes">
            <ul>
              <li>The Docker basics will essentially be the minimum knowledge of Docker you need to complete the workshop.</li>
              <li>File issues or send PRs!</li>
              <li>Pair up</li>
            </ul>
          </aside>
        </section>

        <section>
          <span style="white-space: nowrap;">
            <h3>Agenda</h3>
            <ol>
              <li><a href="#/setup">Setup</a></li>
              <li><a href="#/docker">Docker</a></li>
              <li><a href="#/docker-swarm-carina">Docker Swarm and Carina</a></li>
              <li><a href="#/break">Break</a></li>
              <li><a href="#/notebook">Notebook</a></li>
              <li><a href="#/jupyterhub-carina">JupyterHub on Carina</a></li>
              <li><a href="#/wrap-up">Wrap up</a></li>
            </ol>
          </span>
        </section>

<!-- ********************************************************************** -->

        <section id="setup">
          <h1 style="color:DeepSkyBlue">Setup</h1>
        </section>

        <section>
          <h3>Log In</h3>
          <p>Log in to the Carina GUI.</p>
          <ul>
            <li><a href="https://app.getcarina.com/" target="_blank">Log In</a></li>
            <li>Use your Rackspace public cloud username/password</li>
            <li>Don't create a cluster just yet</li>
            <li>Note your API Key under your username in the top right corner</li>
          </ul>
        </section>

        <section id="installation">
          <h3>Installation</h3>
          <ol>
            <li>Docker Version Manager</li>
            <ol>
              <li>Utility for managing Docker client versions</li>
              <li><a href="https://getcarina.com/docs/tutorials/docker-version-manager/" target="_blank">Manage Docker client versions with dvm</a>
              <li>Do the <b>Install dvm</b> section only</li>
              <li><code>dvm install 1.10.1</code></li>
            </ol>
            <li>Carina CLI</li>
            <ol>
              <li>The CLI for the Caria API</li>
              <li><a href="https://getcarina.com/docs/getting-started/getting-started-carina-cli/" target="_blank">Getting started with the Carina CLI</a>
              <li>Do the <b>Download and install the CLI</b> and <b>Configure with Carina credentials</b> sections only</li>
              <li><code>carina ls</code></li>
            </ol>
          </ol>
        </section>

        <section>
          <h3>Site Overview</h3>
          <p>Get a feel for the Carina website.</p>
          <ul>
            <li><a href="https://getcarina.com/" target="_blank">Carina</a></li>
            <li>Documentation</li>
              <ul>
                <li>Note: Edit on GitHub</li>
              </ul>
            <li>Community</li>
              <ul>
                <li>Use your Rackspace public cloud username/password</li>
              </ul>
            <li>Blog</li>
              <ul>
                <li>Subscribe via RSS</li>
              </ul>
          </ul>
        </section>

        <section>
          <h3>Add a Cluster</h3>
          <p>Setup a cluster where we can run Docker containers</p>
          <ul>
            <li>Add Cluster</li>
              <ul>
                <li>Cluster Name: mycluster</li>
                <li>Enable Autoscale: unchecked</li>
              </ul>
            <li>Get Access</li>
              <ul>
                <li>Download File</li>
                <li>Unzip</li>
                <li>List files</li>
              </ul>
          </ul>
          <aside class="notes">
            This is the last time we touch the GUI. Everything is on the command line from here on out.
          </aside>
        </section>

<!-- ********************************************************************** -->

        <section id="docker">
          <h1 style="color:DeepSkyBlue">Docker</h1>
        </section>

        <section>
          <h3>Comparison</h3>
          <table>
            <tr>
              <td><img src="img/what-is-docker-diagram.png" width="400" height="auto"></td>
              <td><img src="img/what-is-vm-diagram.png" width="400" height="auto"></td>
            </tr>
            <tr>
              <td style="text-align:center">VMs</td>
              <td style="text-align:center">Containers</td>
            </tr>
          </table>
        </section>

        <section>
          <h3>Benefits</h3>
          <ul>
            <li>Better resource utilization</li>
            <li>Application packaging (Docker images)</li>
            <li>Process isolation</li>
            <li>Reproducible environments</li>
            <li>Composable</li>
            <li>Cloud agnostic</li>
          </ul>
        </section>

        <section>
          <h3>Docker Client</h3>
          <p>The CLI for the Docker API</p>
          <ul>
            <li>Containers</li>
            <li>Images</li>
            <li>Volumes</li>
            <li>Networks</li>
            <li>etc</li>
          </ul>
        </section>

        <section>
          <h2>Containers</h2>
          <ul>
            <li>cgroups for limiting resource usage</li>
            <li>namespaces for isolation</li>
            <li>union filesystem for a layered filesystem</li>
          </ul>
        </section>

        <section>
          <h3>Docker Environment</h3>
          <pre><code class="bash" data-trim data-noescape>
$ alias de="env | grep DOCKER_"

<span class="fragment">$ cd Downloads/mycluster</span>

<span class="fragment">$ cat README.md</span>
<span class="fragment">Using Your Swarm Cluster
========================

This directory contains all of the files the Docker CLI will need to
communicate with your Swarm Cluster...</span>

<span class="fragment">$ source docker.env</span>

<span class="fragment">$ de</span>
<span class="fragment">DOCKER_HOST=tcp://146.20.68.14:2376
DOCKER_TLS_VERIFY=1
DOCKER_CERT_PATH=/Users/everett/Downloads/mycluster
DOCKER_VERSION=1.10.1</span>

<span class="fragment">$ dvm use</span>
<span class="fragment">Now using Docker 1.10.1</span>
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker
<span class="fragment">Usage: docker [OPTIONS] COMMAND [arg...]
       docker [ --help | -v | --version ]

A self-sufficient runtime for containers...</span>

<span class="fragment">$ docker ps</span>
<span class="fragment">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
2c226fad0713        carina/consul       "/bin/consul agent -b"   2 days ago          Up 2 days                               96afcb76-6483-443e-941d-df9f803a4628-n2/carina-svcd
c715e66154c8        carina/consul       "/bin/consul agent -b"   3 days ago          Up 3 days                               96afcb76-6483-443e-941d-df9f803a4628-n1/carina-svcd</span>

<span class="fragment">$ docker run --interactive --tty alpine:3.3 /bin/sh</span>
<span class="fragment">/ #</span>
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code class="bash" data-trim data-noescape>
# uname -a
<span class="fragment">Linux d020582f8e97 3.18.21-1-rackos #1 SMP Tue Oct 6 18:37:31 UTC 2015 x86_64 Linux</span>

<span class="fragment"># ps</span>
<span class="fragment">PID   USER     TIME   COMMAND
    1 root       0:00 /bin/sh
   17 root       0:00 ps</span>

<span class="fragment"># exit</span>
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code class="bash" data-trim data-noescape>
<span class="fragment">$ docker ps --latest</span>
<span class="fragment">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS                     PORTS               NAMES
d020582f8e97        alpine:3.3          "/bin/sh"           5 minutes ago       Exited (0) 1 seconds ago                       96afcb76-6483-443e-941d-df9f803a4628-n2/pedantic_yalow</span>

<span class="fragment">$ docker ps --latest --quiet</span>
<span class="fragment">d020582f8e97</span>

<span class="fragment">$ docker start $(docker ps -l -q)</span>
<span class="fragment">d020582f8e97</span>

<span class="fragment">$ docker ps -l</span>
<span class="fragment">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
d020582f8e97        alpine:3.3          "/bin/sh"                6 minutes ago       Up 10 seconds                           96afcb76-6483-443e-941d-df9f803a4628-n2/pedantic_yalow</span>

<span class="fragment">$ docker attach $(docker ps -l -q)
(Press enter if you just get a blank line)</span>

<span class="fragment"># exit</span>

<span class="fragment">$ docker rm $(docker ps -l -q)</span>
<span class="fragment">d020582f8e97</span>
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker run --detach --name ghost --publish 8080:2368 ghost:0.7
<span class="fragment">fbe7b7f520e8ba08925f4a2df1cd7d66bbacd25164656e25fca34e24127e7c73</span>

<span class="fragment">$ docker logs ghost</span>
<span class="fragment">...
Migrations: Complete
Ghost is running in development...
Listening on 0.0.0.0:2368
Url configured as: http://localhost:2368
Ctrl+C to shut down</span>

<span class="fragment">$ docker ps -l</span>
<span class="fragment">CONTAINER ID        IMAGE               COMMAND                  CREATED              STATUS              PORTS                          NAMES
fbe7b7f520e8        ghost:0.7           "/entrypoint.sh npm s"   About a minute ago   Up About a minute   172.99.77.191:8080->2368/tcp   96afcb76-6483-443e-941d-df9f803a4628-n2/ghost</span>

<span class="fragment">$ open http://$(docker port ghost 2368/tcp)</span>

<span class="fragment">$ docker rm --force ghost</span>
<span class="fragment">ghost</span>
          </code></pre>
        </section>

        <section>
          <h3>Lab</h3>
          <ol>
            <li>Run an <code>nginx:1.9</code> container in detached mode</li>
            <li>Bind the container port 80 to the host port 80</li>
            <li>View the default nginx landing page</li>
            <li>Bonus Points: Replace the default nginx landing page using <code>docker cp</code> and a file from your laptop</li>
            <li>Stop the container and remove it</li>
          </ol>
          <aside class="notes">
            <pre><code class="bash" data-trim data-noescape>
docker run --detach --name nginx --publish 80:80 nginx:1.9
chmod r+x README.md
docker cp README.md nginx:/usr/share/nginx/html/index.html
open http://$(docker port nginx 80/tcp)
docker rm --force nginx
            </code></pre>
          </aside>
        </section>

        <section>
          <h2>Container Resources</h2>
          <ul>
            <li><a href="https://docs.docker.com/engine/userguide/containers/usingdocker/" target="_blank">Using Docker</a></li>
            <li><a href="https://docs.docker.com/engine/understanding-docker/" target="_blank">Understand the architecture</a></li>
            <li><a href="https://docs.docker.com/engine/reference/run/" target="_blank">Docker run reference</a></li>
            <li><a href="https://docs.docker.com/engine/reference/commandline/cli/" target="_blank">Use the Docker command line</a></li>
          </ul>
        </section>

        <section>
          <h2>Images</h2>
          <ul>
            <li>You can kinda sorta think of it like an image for a VM, but really it's a very different beast</li>
            <li>Layered filesystems</li>
            <li>Top layer is rw and the layers below are ro</li>
            <li>There's an analogy to Git but we won't be using <code>docker commit</code></li>
          </ul>
        </section>

        <section>
          <h3>Images</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker images
<span class="fragment">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE
alpine              3.3                 90239124c352        31 hours ago        4.794 MB
cirros              latest              f8ce316a37a7        6 weeks ago         7.735 MB
nginx               1.9                 69203b7cd029        7 days ago          134.6 MB
swarm               1.1.0               4b5b33ba4e4f        2 weeks ago         18.11 MB
ghost               0.7                 c39498b8f953        2 weeks ago         352.2 MB
carina/consul       latest              2a49945a93ab        2 weeks ago         28.49 MB</span>

<span class="fragment">$ docker pull alpine:3.3</span>
<span class="fragment">96afcb76-6483-443e-941d-df9f803a4628-n1: Pulling alpine:3.3... : downloaded</span>
          </code></pre>
        </section>

        <section>
          <h3>Dockerfile</h3>
          <ul>
            <li>Uses a basic DSL with instructions for building Docker images</li>
            <li>Provides a repeatable, transparent, and idempotent mechanism for creating images</li>
            <li>Each instruction adds a new layer to the image and then commits the image</li>
          </ul>
        </section>

        <section>
          <h3>Images</h3>
          <pre><code class="bash" data-trim data-noescape>
$ mkdir workshop

<span class="fragment">$ cd workshop</span>

<span class="fragment">$ touch Dockerfile</span>

<span class="fragment">$ touch entrypoint.sh</span>

<span class="fragment">$ chmod u+x entrypoint.sh</span>
          </code></pre>
        </section>

        <section>
          <h3>Dockerfile</h3>
          <p>Edit <code>Dockerfile</code></p>
          <pre><code class="bash" data-trim>
FROM alpine:3.3
MAINTAINER Firstname Lastname "firstname.lastname@example.com"

ARG BUILD_TIME_VAR="Default Build Time Message"
ENV RUN_TIME_VAR="Default Run Time Message"

RUN apk --no-cache add nginx

COPY entrypoint.sh /entrypoint.sh

WORKDIR /usr/share/nginx/html/

RUN echo $BUILD_TIME_VAR >> index.html

EXPOSE 80

ENTRYPOINT ["/entrypoint.sh"]
CMD ["Default CMD Message"]
          </code></pre>
        </section>

        <section>
          <h3>Entrypoint Script</h3>
          <p>Edit <code>entrypoint.sh</code></p>
          <pre><code class="bash" data-trim>
#!/bin/sh

set -euo pipefail

echo $RUN_TIME_VAR >> /usr/share/nginx/html/index.html
echo $1 >> /usr/share/nginx/html/index.html

exec nginx -g "daemon off;"
          </code></pre>
        </section>

        <section>
          <h3>Images</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker build --build-arg BUILD_TIME_VAR="Chop Wood," --tag="nginx-message:1.0" .
<span class="fragment">Sending build context to Docker daemon 3.072 kB
Step 1 : FROM alpine:3.3
 ---> 90239124c352
...
Successfully built 3f7493082af2</span>

<span class="fragment">$ docker images</span>
<span class="fragment">REPOSITORY          TAG                 IMAGE ID            CREATED              SIZE
nginx-message       1.0                 3f7493082af2        About a minute ago   6.249 MB
...</span>
          </code></pre>
        </section>

        <section>
          <h3>Images</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker run --detach \
  --name nginx \
  --publish 80:80 \
  --env RUN_TIME_VAR="Carry Water," \
  nginx-message:1.0 \
  "Mow Lawn"
<span class="fragment">3f98a5832b79fe43f97aa07aaa9e425fa33cb7e195e61a6b0d39dfdd4dc0195e</span>

<span class="fragment">$ open http://$(docker port nginx 80/tcp)</span>

<span class="fragment">$ docker rm --force nginx</span>
<span class="fragment">nginx</span>
          </code></pre>
        </section>

        <section>
          <h2>Image Resources</h2>
          <ul>
            <li><a href="https://hub.docker.com/" target="_blank">Docker Hub</a></li>
            <li><a href="https://docs.docker.com/engine/userguide/containers/dockerimages/" target="_blank">Build your own images</a></li>
            <li><a href="https://docs.docker.com/engine/reference/builder/" target="_blank">Dockerfile reference</a></li>
            <li><a href="https://docs.docker.com/engine/userguide/eng-image/dockerfile_best-practices/" target="_blank">Best practices for writing Dockerfiles</a></li>
          </ul>
        </section>

        <section>
          <h2>Volumes</h2>
          <ul>
            <li>A specially-designated directory within one or more containers that bypasses the container's Union File System</li>
            <li>Data is written directly to the segment</li>
            <li>Designed to persist data, independent of the containerâ€™s life cycle</li>
            <li>Can be shared and reused among containers</li>
          </ul>
        </section>

        <section>
          <h3>Volumes</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker create --name data --volume /var/lib/mysql cirros /bin/true
<span class="fragment">162bf49dbc24245a53095b5be611da3e820862dc8e837a66dab83d7e3f9d5b5a</span>

<span class="fragment">$ docker ps -l
<span class="fragment">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES
162bf49dbc24        cirros              "/bin/true"         12 seconds ago                                              96afcb76-6483-443e-941d-df9f803a4628-n2/data</span>

<span class="fragment">$ docker run --detach \
  --name mysql \
  --volumes-from data \
  --env MYSQL_ROOT_PASSWORD=my-root-pw --env MYSQL_DATABASE=test --env MYSQL_USER=test-user --env MYSQL_PASSWORD=test-password \
  mysql:5.6</span>
<span class="fragment">6c38ad9739c47933e0a415912fbec83190bc519650dcb1412091d207f09a040d</span>

<span class="fragment">$ docker run --rm \
  --volumes-from data \
  cirros \
  ls /var/lib/mysql</span>
<span class="fragment">auto.cnf
ib_logfile0
ib_logfile1
ibdata1
mysql
performance_schema
test</span>
          </code></pre>
        </section>

        <section>
          <h3>Volumes</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker rm -f mysql
<span class="fragment">mysql</span>

<span class="fragment">$ docker run --rm \
  --volumes-from data \
  cirros \
  ls /var/lib/mysql</span>
<span class="fragment">auto.cnf
ib_logfile0
ib_logfile1
ibdata1
mysql
performance_schema
test</span>

<span class="fragment">$ docker rm --volumes data</span>
<span class="fragment">data</span>
          </code></pre>
        </section>

        <section>
          <h2>Image Resources</h2>
          <ul>
            <li><a href="https://getcarina.com/docs/tutorials/data-volume-containers/" target="_blank">Use data volume containers</a> (Carina)</li>
            <li><a href="https://docs.docker.com/engine/userguide/containers/dockervolumes/" target="_blank">Manage data in containers</a></li>
            <li>Why didn't we use <code>docker volume</code>?</li>
            <ul>
              <li>See <a href="https://github.com/docker/swarm/issues/1529" target="_blank">The utility of creating a volume per node</a></li>
            </ul>
          </ul>
        </section>

        <section>
          <h2>Networks</h2>
          <ul>
            <li>Added to Carina last Monday!</li>
            <li>A secured and isolated environment for the containers in a network</li>
            <li>Automatic name resolution of containers using DNS</li>
            <li>The ability to dynamically connect containers to and disconnect containers from multiple networks</li>
          </ul>
        </section>

        <section>
          <h3>Networks</h3>
          <pre><code class="bash" data-trim data-noescape>
$ docker network create mynet
<span class="fragment">0b1194e03c4747be069eef05b6db67c13974d9717ebd859fcff7aa322aa48d9b</span>

<span class="fragment">$ docker network ls</span>
<span class="fragment">NETWORK ID          NAME                                                      DRIVER
0b1194e03c47        mynet                                                     overlay
33a440068243        96afcb76-6483-443e-941d-df9f803a4628-n1/none              null
3b126dcfc9ea        96afcb76-6483-443e-941d-df9f803a4628-n1/bridge            bridge
60cecf066b00        96afcb76-6483-443e-941d-df9f803a4628-n1/host              host
c3a94fdde28f        96afcb76-6483-443e-941d-df9f803a4628-n1/docker_gwbridge   bridge</span>

<span class="fragment">$ docker run \
  --detach \
  --name mysql \
  --net mynet \
  --env MYSQL_ROOT_PASSWORD=my-root-pw \
  mysql:5.6</span>
<span class="fragment">60d49ac074902a721d6a90af5c4bd85363bed0a998fd4b19da61198f5340b73d</span>

<span class="fragment">$ docker port mysql 3306</span>
<span class="fragment">Error: No public port '3306/tcp' published for mysql</span>
          </code></pre>
        </section>

        <section>
          <h3>Networks</h3>
          <pre><code class="bash" data-trim data-noescape>
docker run --detach \
  --name wordpress \
  --net mynet \
  --publish 80:80 \
  --env WORDPRESS_DB_HOST=mysql \
  --env WORDPRESS_DB_PASSWORD=my-root-pw \
  wordpress:4.4
<span class="fragment">c7ebba7f81c1cf48bddbea6d3080713bea58b9de38ee7e7d422b0010b33daf12</span>

<span class="fragment">$ open http://$(docker port wordpress 80/tcp)</span>

<span class="fragment">$ docker rm -f mysql wordpress</span>
<span class="fragment">mysql
wordpress</span>
          </code></pre>
        </section>

        <section>
          <h3>Networks</h3>
          <pre><code class="bash" data-trim data-noescape>
<span class="fragment">$ docker ps
<span class="fragment">CONTAINER ID        IMAGE               COMMAND                  CREATED             STATUS              PORTS               NAMES
2c226fad0713        carina/consul       "/bin/consul agent -b"   2 days ago          Up 2 days                               96afcb76-6483-443e-941d-df9f803a4628-n2/carina-svcd
c715e66154c8        carina/consul       "/bin/consul agent -b"   3 days ago          Up 3 days                               96afcb76-6483-443e-941d-df9f803a4628-n1/carina-svcd
          </code></pre>
        </section>

        <section>
          <h2>Network Resources</h2>
          <ul>
            <li><a href="https://getcarina.com/blog/overlay-networks/" target="_blank">Overlay networks</a> (Carina)</li>
            <li><a href="https://docs.docker.com/engine/userguide/networking/dockernetworks/" target="_blank">Understand Docker container networks</a></li>
            <li><a href="https://docs.docker.com/engine/userguide/networking/work-with-networks/" target="_blank">Work with network commands</a></li>
            <li><a href="https://docs.docker.com/engine/userguide/networking/get-started-overlay/" target="_blank">Get started with overlay networking</a></li>
            <li><a href="https://docs.docker.com/engine/userguide/networking/configure-dns/" target="_blank">Embedded DNS server in user-defined networks</a></li>
          </ul>
        </section>

<!-- ********************************************************************** -->

        <section id="docker-swarm-carina">
          <h1 style="color:DeepSkyBlue">Docker Swarm and Carina</h1>
          <img src="img/docker-swarm.png"/>

          <aside class="notes">
            <ul>
              <li>So what is Carina? Docker as a Service</li>
              <li>Today vs Future (mesos, kubernetes)</li>
            </ul>
          </aside>
        </section>

        <section>
          <h2>Docker Swarm</h2>
          <ul>
            <li>Many Docker Hosts, one API endpoint</li>
            <li>Introduces new concepts, like affinities</li>
            <li>Scheduling according to resource constraints</li>
          </ul>

          <aside class="notes">
            <ul>
              <li>Treat cluster of dockers as 1 docker</li>
              <li>Same docker commands</li>
              <li>Scheduling = pick which host on which to run commands</li>
            </ul>
          </aside>
        </section>

        <section>
          <img src="img/carina-topology.png"/>

          <aside class="notes">
            <ul>
              <li>Handles the setup and managment</li>
              <li>SEGMENTS! SEGMENTS! SEGMENTS!</li>
              <li>This is how we scale</li>
              <li>Walkthrough flow of commands</li>
            </ul>
          </aside>
        </section>

        <section>
            <section>
            <h3>Carina CLI</h3>
            <p><a href="https://getcarina.com/docs/getting-started/getting-started-carina-cli/">See installation and configuration instructions</a></p>

            <div class="fragment">
              <h4>List your Clusters</p>
              <pre><code class="bash" data-trim data-noescape>
$ carina ls
<span class="fragment">ClusterName       Flavor           Segments           AutoScale          Status
mycluster         container1-4G    1                  false              active</span>
              </code></pre>
            </div>

            <div class="fragment">
              <h4>Create a Cluster</h4>
              <pre><code class="bash" data-trim data-noescape>
$ carina create --wait foobar
<span class="fragment">ClusterName     Flavor          Segments         AutoScale        Status
foobar          container1-4G   1                false            active</span>
              </code></pre>
            </div>

            <div class="fragment">
              <h4>Rebuild a Cluster</h4>
              <pre><code class="bash" data-trim data-noescape>
$ carina rebuild foobar
<span class="fragment">ClusterName     Flavor          Segments         AutoScale        Status
foobar          container1-4G   1                false            rebuilding-swarm</span>
              </code></pre>
            </div>

            <aside class="notes">
              <ul>
                <li>Websites are cool but command-line tools are cooler.
                    Everything you can do with the site, you can do through the cli</li>
                <li>Behind the scenes carina is downloading your credentials zip</li>
                <li>Nice shorthand for the source docker.env command used earlier</li>
              </ul>
            </aside>
          </section>

          <section>
            <h4>Load the Docker environment for your Cluster</h4>
            <pre><code class="bash" data-trim data-noescape>
$ carina env mycluster
<span class="fragment">source /Users/caro8994/.carina/clusters/carolynvsrax/mycluster/docker.env
# Run the command below to get your Docker environment variables set:
# eval $(carina env mycluster)</span>

<span class="fragment">PS> carina env mycluster --shell powershell
. C:\Users\caro8994\carina\clusters\carolynvsrax\mycluster\docker.ps1
# Run the command below to get your Docker environment variables set:
# carina env mycluster --shell powershell | iex</span>

<span class="fragment">$ eval $(carina env mycluster)
PS> carina env mycluster --shell powershell | iex</span>

<span class="fragment">$ docker ps</span>
<span class="fragment">CONTAINER ID      IMAGE      COMMAND                  CREATED             STATUS
ab668e03cafb      logjam     "tail -f /var/log/foo"   3 seconds ago       Up 3 seconds</span>
            </code></pre>
          </section>

          <section>
            <h4>Grow Your Cluster</h4>
            <pre><code class="bash" data-trim data-noescape>
$ carina ls
<span class="fragment">ClusterName        Flavor             Segments           AutoScale          Status
mycluster          container1-4G      1                  false              active</span>
<span class="fragment">
$ carina grow --by 1 mycluster</span>
<span class="fragment">ClusterName        Flavor             Segments           AutoScale          Status
mycluster          container1-4G      1                  false              growing</span>
<span class="fragment">
$ carina ls</span>
<span class="fragment">ClusterName        Flavor             Segments           AutoScale          Status
mycluster          container1-4G      2                  false              active</span>
            </code></pre>
          </section>
        </section>

      <section>
        <h3>Swarm Scheduling in Action</h3>
        <pre><code class="bash" data-trim data-noescape>
$ <span class="fragment">docker run --name whoa1 --detach --publish 80:8080 rackerlabs/whoa</span>
<span class="fragment">44aff6801d136ae7ba49ad074d94a7ba94740326f8d9099d7830ec8095abdf72</span>
<span class="fragment">
$ docker port whoa1 8080</span>
<span class="fragment">104.130.0.119:80</span>
<span class="fragment">
$ docker run --name whoa2 --detach --publish 80:8080 rackerlabs/whoa</span>
<span class="fragment">5e0a9815f9558c7a26a44f3bb214f241a5fbf26e01e008739dff64e39c802fce</span>
<span class="fragment">
$ docker port whoa2 8080</span>
<span class="fragment">104.130.0.117:80</span>
<span class="fragment">
$ curl $(docker port whoa1)</span>
<span class="fragment">ðŸŽ‰ Whoa! ðŸŽ‰</span>
        </code></pre>

        <aside class="notes">
          <ul>
            <li>Now we have 2 segments, let's fill them up with stuff.</li>
            <li>Each segment is a docker host</li>
            <li>Segment IP Address</li>
            <li>Publish to same port across segments</li>
          </ul>
        </aside>
      </section>

      <section>
          <h3>LAB</h3>
          <ol>
            <li>Create a new cluster</li>
            <li>Load the Docker environment for the new cluster</li>
            <li>Grow the cluster to 3 segments</li>
            <li>Run 3 instances of `rackerlabs/whoa` on port 80</li>
          </ol>
      </section>

      <section>
        <h3>Where does it run?</h3>

        <p>Factors that implicitly influence container placement</p>

        <ul>
          <li><code>--publish</code> finds a node with the published port free</li>
          <li><code>--volumes-from</code> uses the same node as the named container</li>
          <li><code>--link</code> uses the same node aside the named container</li>
        </ul>

        <aside class="notes">
          When Swarm schedules a new container, a number of factors determine which node it places
          the container on. Containers related with these docker arguments will automatically be
          scheduled together.
        </aside>
      </section>

      <section>
        <h3>Constraints and Affinity</h3>

        <p>Explicitly influence where your containers run</p>
        <p>Set by environment variables or build arguments</p>
<pre><code class="bash" data-noescape>
# Run on the same node as another container
$ docker run --env affinity:container==backend ...

# Run on a node where image is available
$ docker run --env affinity:image==myapp ...

# Explicit node name
$ docker run --env constraint:node==6dcd3c04-fab5-4367-ac39-d8b17c41c39c-n1 ...

# Build a new image on the same node as an existing container
$ docker build --build-arg affinity:image==myapp -t myapp:v2 .
</code></pre>

        <aside class="notes">
          Generally speaking, constraints filter on docker daemon attributes, while affinities
          filter on attributes of other containers on each node. You can also use custom container
          metadata labels for lots of control.
        </aside>
      </section>

      <section>
        <h1>Carina</h1>

        <h3>Push Button, Receive Swarm</h3>

        <img src="img/push-button-receive-bacon.jpg"/>

        <aside class="notes">
          With some limitations
        </aside>
      </section>

      <section>
        <h3>Carina Clusters</h3>

        <ul>
          <li>1 to 3 <em>"segments"</em>; LXC containers on a physical host</li>
          <li>20 GB disk space, 4 GB memory, 2 vCPUs per segment</li>
          <li>Each segment has its own public IP, discoverable via <code>docker info</code></li>
        </ul>

        <pre><code class="nohighlight fragment" data-trim data-noescape>
$ docker info
Containers: 9
Images: 13
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 3
 6dcd3c04-fab5-4367-ac39-d8b17c41c39c-n1: <mark>172.99.73.138</mark>:42376
  â”” Containers: 3
  â”” Reserved CPUs: 0 / 12
  â”” Reserved Memory: 0 B / 4.2 GiB
  â”” Labels: executiondriver=native-0.2, kernelversion=3.18.21-1-rackos, ...
        </pre></code>

        <aside class="notes">
          Carina segments are for resource control, not geographic redundancy.
        </aside>
      </section>

      <section>
        <h3>Carina Restrictions</h3>
        <ul>
          <li>Volumes only allowed within <code>/var/lib/docker</code></li>
          <li>No <code>--privileged</code> containers or <code>--cap-add</code>/<code>--cap-drop</code></li>
          <li>Limited device access</li>
        </ul>

        <p class="fragment"><em>...but other than that, it's just Swarm</em></p>

        <aside class="notes">
          Mostly these are related to security needs. Prefer using data volume containers to host
          volumes.
        </aside>
      </section>

      <section>
        <h3>Lab</h3>
        <ol>
          <li>Run a <code>rackerlabs/whoa</code> container</li>
          <li>Create a data volume container (DVC) on the same segment</li>
          <li>Use <code>docker cp</code> to upload a self-signed TLS certificate to the DVC</li>
          <li>
            Run an <code>nginx:1.9</code> container that:
            <ul>
              <li>mounts the volume from the DVC</li>
              <li>publishes port 443 and uses your TLS certificate</li>
              <li>proxies traffic to the <code>rackerlabs/whoa</code> container</li>
            </ul>
          </li>
        </ol>
        <hr>
        <ul>
          <li><em>Resources:</em> <a href="https://github.com/everett-toews/jupyterhub-on-docker-swarm/blob/gh-pages/resources/selfsigned.sh"><code>openssl</code>-fu</a> | <a href="https://github.com/everett-toews/jupyterhub-on-docker-swarm/blob/gh-pages/resources/nginx.conf">NGINX configuration template</a></li>
          <li><em>Hint:</em> <code>docker ps</code> will show which segment each container is on</li>
        </ul>
        <aside class="notes">
          <pre><code class="bash" data-trim data-noescape>
docker run -d --name backend rackerlabs/whoa
docker create --name certs -v /certificates -e affinity:container==whoa busybox
docker cp ./private-key.pem certs:/certificates/private-key.pem
docker cp ./public-certificate.pem certs:/certificates/public-certificate.pem
docker build -t my-nginx -f resources/Dockerfile.nginx --build-arg affinity:container==certs resources/
docker run -d --name my-nginx --volumes-from certs -p 443:443 my-nginx
          </code></pre>
        </aside>
      </section>

<!-- ********************************************************************** -->

        <section id="break">
          <h1 style="color:DeepSkyBlue">Break</h1>
        </section>

<!-- ********************************************************************** -->

        <section id="notebook">
          <h1 style="color:DeepSkyBlue">Notebook</h1>
        </section>

        <section>
          <h2>Outline</h2>
          <ul>
            <li>Interactive Literate Coding</li>
            <li>Collaboration</li>
            <li>Visualization</li>
            <li>Rich objects</li>
            <li>Share-able documents</li>
          </ul>
          <aside class="notes">
              The notebook gives you an environment where you can mix and match
              code, prose, and outputs within a document that you can share with
              others
          </aside>
        </section>

        <section>
          <h3>Living Code</h3>
          <img src="img/interactive-notebook.png"></img>
        </section>

        <section>
          <h2>Let's try it live!</h2>
          <h3><a href="https://tmpnb.org">tmpnb.org</a></h3>
        </section>

<!-- ********************************************************************** -->

        <section id="jupyterhub-carina">
          <h1 style="color:DeepSkyBlue">JupyterHub on Carina</h1>
        </section>

        <section>
          <h2>JupyterHub Architecture</h2>
            <ul>
              <li>Notebook servers for users</li>
              <li>Configurable HTTP Proxy</li>
              <li>Bring your own auth</li>
            </ul>
        </section>

        <section>
          <h2>Outline</h2>
          <ul>
            <li>Create a new cluster</li>
            <li>Clone the repo for this preso</li>
            <li>Rely on jupyterhub-launch</li>
          </ul>
        </section>

        <section>
          <h3>Create a new cluster</h3>
          <pre><code class="bash" data-trim data-noescape>
carina create jupyterhub --wait
          </code></pre>
        </section>

<!-- That's one long repo name for the board -->
        <section>
          <h3>Clone this repo</h3>
          <pre><code class="bash" data-trim data-noescape>
git clone https://github.com/everett-toews/jupyterhub-on-docker-swarm
          </code></pre>
        </section>

        <section>
          <h3>Launch</h3>
          <pre><code class="bash" data-trim data-noescape>
cd jupyterhub-on-docker-swarm # if you're not already there
cd jupyterhub-launch
carina env jupyterhub
# TODO: Environment variables, OAauth, Domain
./launch.sh
          </code></pre>
        </section>


<!-- ********************************************************************** -->

        <section id="wrap-up">
          <h1 style="color:DeepSkyBlue">Wrap up</h1>
        </section>

        <section>
          <h1>Thanks!</h1>
          <ul>
            <li><a href="https://rax.io/workshops-feedback" target="_blank">Feedback survey</a></li>
          </ul>
        </section>

<!-- ********************************************************************** -->

      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: false,
        slideNumber: 'h/v',
        progress: false,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
