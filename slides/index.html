<!doctype html>
<html lang="en">

  <head>
    <meta charset="utf-8">

    <title>JupyterHub on Docker Swarm</title>

    <meta name="description" content="Deploy an interactive data science environment with JupyterHub on Docker Swarm">
    <meta name="author" content="Kyle Kelley">
    <meta name="author" content="Carolyn Van Slyck">
    <meta name="author" content="Everett Toews">
    <meta name="author" content="Ash Wilson">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, minimal-ui">

    <link rel="stylesheet" href="css/reveal.css">
    <link rel="stylesheet" href="css/theme/night.css" id="theme">

    <!-- Code syntax highlighting -->
    <link rel="stylesheet" href="lib/css/zenburn.css">

    <!-- Printing and PDF exports -->
    <script>
      var link = document.createElement( 'link' );
      link.rel = 'stylesheet';
      link.type = 'text/css';
      link.href = window.location.search.match( /print-pdf/gi ) ? 'css/print/pdf.css' : 'css/print/paper.css';
      document.getElementsByTagName( 'head' )[0].appendChild( link );
    </script>

    <!--[if lt IE 9]>
    <script src="lib/js/html5shiv.js"></script>
    <![endif]-->
  </head>

  <body>

    <div class="reveal">
      <!-- Any section element inside of this container is displayed as a slide -->
      <div class="slides">
        <section id="welcome">
          <h4>Deploy an interactive data science environment</h4>
          <h5>with JupyterHub on Docker Swarm</h5>
          <img src="img/docker-swarm.png"/>
          <h4><a href="http://rack.to/jupyterhub-on-docker-swarm">rack.to/jupyterhub-on-docker-swarm</a></h4>
          <p style="font-size: 50%;">Use the arrow keys to navigate</p>
        </section>

        <section id="instructors">
          <h3>Instructors</h3>
          <center>
            <table>
              <tbody>
                <tr>
                  <td>Kyle Kelley</td>
                  <td><a href="https://twitter.com/rgbkrk" target="_blank">@rgbkrk</a></td>
                </tr>
                <tr>
                  <td>Carolyn Van Slyck</td>
                  <td><a href="https://twitter.com/carolynvs" target="_blank">@carolynvs</a></td>
                </tr>
                <tr>
                  <td>Everett Toews</td>
                  <td><a href="https://twitter.com/everett_toews" target="_blank">@everett_toews</a></td>
                </tr>
                <tr>
                  <td>Ash Wilson</td>
                  <td><a href="https://twitter.com/smashwilson" target="_blank">@smashwilson</a></td>
                </tr>
              </tbody>
            </table>
          </center>
        </section>

        <section id="goals">
          <h3>Goals</h3>
          <p>Learn Docker basics and Docker Swarm fundamentals. To exercise these fundamentals the participants will deploy JupyterHub on <a href="https://getcarina.com/" target="_blank">Carina</a>, a hosted Docker Swarm environment. Along the way they'll also gain a better understanding of Jupyter, an open source web application that allows you to create and share documents that contain live code, equations, visualizations, and explanatory text.</p>
          <aside class="notes">
            <ul>
              <li>The Docker basics will essentially be the minimum knowledge of Docker you need to complete the workshop.</li>
              <li>File issues or send PRs!</li>
              <li>Pair up</li>
            </ul>
          </aside>
        </section>

        <section>
          <span style="white-space: nowrap;">
            <h3>Agenda</h3>
            <ol>
              <li><a href="#/setup">Setup</a></li>
              <li><a href="#/docker">Docker</a></li>
              <li><a href="#/docker-swarm-carina">Docker Swarm and Carina</a></li>
              <li><a href="#/break">Break</a></li>
              <li><a href="#/notebook">Notebook</a></li>
              <li><a href="#/jupyterhub-carina">JupyterHub on Carina</a></li>
              <li><a href="#/wrap-up">Wrap up</a></li>
            </ol>
          </span>
        </section>

<!-- ********************************************************************** -->

        <section id="setup">
          <h1 style="color:DeepSkyBlue">Setup</h1>
        </section>

        <section>
          <h3>Log In</h3>
          <p>Log in to the Carina GUI.</p>
          <ul>
            <li><a href="https://app.getcarina.com/" target="_blank">Log In</a></li>
            <li>Use your Rackspace public cloud username/password</li>
            <li>Don't create a cluster just yet</li>
            <li>Note your API Key under your username in the top right corner</li>
          </ul>
        </section>

        <section id="installation">
          <h3>Installation</h3>
          <ol>
            <li>Docker Version Manager</li>
            <ol>
              <li>Utility for managing Docker client versions</li>
              <li><a href="https://getcarina.com/docs/tutorials/docker-version-manager/" target="_blank">Manage Docker client versions with dvm</a>
              <li>Do the <b>Install dvm</b> section only</li>
              <li><code>dvm install 1.10.1</code></li>
            </ol>
            <li>Carina CLI</li>
            <ol>
              <li>The CLI for the Caria API</li>
              <li><a href="https://getcarina.com/docs/getting-started/getting-started-carina-cli/" target="_blank">Getting started with the Carina CLI</a>
              <li>Do the <b>Download and install the CLI</b> and <b>Configure with Carina credentials</b> sections only</li>
              <li><code>carina ls</code></li>
            </ol>
          </ol>
        </section>

        <section>
          <h3>Site Overview</h3>
          <p>Get a feel for the Carina website.</p>
          <ul>
            <li><a href="https://getcarina.com/" target="_blank">Carina</a></li>
            <li>Documentation</li>
              <ul>
                <li>Note: Edit on GitHub</li>
              </ul>
            <li>Community</li>
              <ul>
                <li>Use your Rackspace public cloud username/password</li>
              </ul>
            <li>Blog</li>
              <ul>
                <li>Subscribe via RSS</li>
              </ul>
          </ul>
        </section>

        <section>
          <h3>Add a Cluster</h3>
          <p>Setup a cluster where we can run Docker containers</p>
          <ul>
            <li>Add Cluster</li>
              <ul>
                <li>Cluster Name: mycluster</li>
                <li>Enable Autoscale: unchecked</li>
              </ul>
            <li>Get Access</li>
              <ul>
                <li>Download File</li>
                <li>Unzip</li>
                <li>List files</li>
              </ul>
          </ul>
          <aside class="notes">
            This is the last time we touch the GUI. Everything is on the command line from here on out.
          </aside>
        </section>

<!-- ********************************************************************** -->

        <section id="docker">
          <h1 style="color:DeepSkyBlue">Docker</h1>
        </section>

        <section>
          <h3>Comparison</h3>
          <table>
            <tr>
              <td><img src="img/what-is-docker-diagram.png" width="400" height="auto"></td>
              <td><img src="img/what-is-vm-diagram.png" width="400" height="auto"></td>
            </tr>
            <tr>
              <td style="text-align:center">VMs</td>
              <td style="text-align:center">Containers</td>
            </tr>
          </table>
        </section>

        <section>
          <h3>Benefits</h3>
          <ul>
            <li>Better resource utilization</li>
            <li>Application packaging (Docker images)</li>
            <li>Process isolation</li>
            <li>Reproducible environments</li>
            <li>Composable</li>
            <li>Cloud agnostic</li>
          </ul>
        </section>

        <section>
          <h3>Docker Client</h3>
          <p>The CLI for the API.</p>
          <ul>
            <li>Containers</li>
            <li>Images</li>
            <li>Volumes</li>
            <li>Networks</li>
            <li>etc</li>
          </ul>
        </section>

        <section>
          <h3>Docker Environment</h3>
          <pre><code data-trim class="bash">
alias de="env | grep DOCKER_"
alias ds="docker ps"

cd Downloads/mycluster
more README.md
source docker.env
de
dvm use
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code data-trim class="bash">
docker
docker version
docker ps # "ps" because it can be thought of like the Linux ps command
docker run --interactive --tty alpine:3.3 /bin/sh
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code data-trim class="bash">
uname -a
hostname
more /etc/hosts
ip a
ps
echo "Hello Docker" > README.txt
more README.txt
ls
exit
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code data-trim class="bash">
docker ps
docker ps --latest
docker ps --latest --quiet
docker start $(docker ps -l -q)
docker ps
docker attach $(docker ps -l -q)
# Press enter if you just get a blank line
more README.txt
exit
docker rm $(docker ps -l -q)
          </code></pre>
        </section>

        <section>
          <h3>Containers</h3>
          <pre><code data-trim class="bash">
docker run --detach --name ghost --publish 8080:2368 ghost:0.7
open http://$(docker port ghost 2368/tcp)
docker ps
docker rm --force $(docker ps -l -q)
          </code></pre>
        </section>

        <section>
          <h3>Lab</h3>
          <ol>
            <li>Run an <code>nginx:1.9</code> container in detached mode</li>
            <li>Bind the container port 80 to the host port 80</li>
            <li>View the default nginx landing page</li>
            <li>Bonus Points: Replace the default nginx landing page using <code>docker cp</code> and a file from your laptop</li>
            <li>Stop the container and remove it</li>
          </ol>
          <aside class="notes">
            <pre><code data-trim class="bash">
docker run --detach --name nginx --publish 80:80 nginx:1.9
docker cp README.md nginx:/usr/share/nginx/html/index.html
open http://$(docker port nginx 80/tcp)
docker rm --force $(docker ps -l -q)
            </code></pre>
          </aside>
        </section>

        <section>
          <h2>Images</h2>
          <ul>
            <li>You can kinda sorta think of it like an image for a VM, but really it's a very different beast</li>
            <li>Layered filesystems</li>
            <li>Top layer is rw and the layers below are ro</li>
            <li>There's an analogy to Git but we won't be using <code>docker commit</code></li>
            <li><a href="https://hub.docker.com/" target="_blank">Docker Hub</a></li>
          </ul>
        </section>

        <section>
          <h3>Images</h3>
          <pre><code data-trim class="bash">
docker images
docker pull alpine:3.3
docker search python
          </code></pre>
        </section>

        <section>
          <h3>Dockerfile</h3>
          <ul>
            <li>Uses a basic DSL with instructions for building Docker images</li>
            <li>Provides a repeatable, transparent, and idempotent mechanism for creating images</li>
            <li>Each instruction adds a new layer to the image and then commits the image</li>
          </ul>
        </section>

        <section>
          <h3>Dockerfile</h3>
          <p>Create a file called <code>Dockerfile</code></p>
          <pre><code data-trim class="bash">
FROM gliderlabs/alpine:3.3
MAINTAINER Firstname Lastname "firstname.lastname@example.com"

ARG BUILD_TIME_MSG="Default Build Time Message"
ENV RUN_TIME_MSG="Default Run Time Message"

RUN apk --no-cache add nginx

COPY entrypoint.sh /entrypoint.sh

WORKDIR /usr/share/nginx/html/

RUN echo $BUILD_TIME_MSG >> index.html

EXPOSE 80

ENTRYPOINT ["/entrypoint.sh"]
          </code></pre>
        </section>

        <section>
          <h3>Entrypoint Script</h3>
          <p>Create a file called <code>entrypoint.sh</code> and make it executable</p>
          <pre><code data-trim class="bash">
#!/bin/sh

set -euo pipefail

echo $RUN_TIME_MSG >> /usr/share/nginx/html/index.html
nginx -g daemon off;
          </code></pre>
        </section>

        <section>
          <h3>Images</h3>
          <pre><code data-trim class="bash">
docker build --build-arg BUILD_TIME_MSG="Chop Wood," --tag="nginx-message:1.0" .
docker images
docker run --detach \
  --name nginx \
  --publish 80:80 \
  --env RUN_TIME_MSG="Carry Water" \
  nginx-message:1.0
open http://$(docker port nginx 80/tcp)
docker rm --force nginx
          </code></pre>
        </section>

<!-- ********************************************************************** -->

        <section id="docker-swarm-carina">
          <h1 style="color:DeepSkyBlue">Docker Swarm and Carina</h1>
          <img src="img/docker-swarm.png"/>
        </section>

        <section>
          <h2>Docker Swarm</h2>
          <ul>
            <li>Many Docker Hosts, one API endpoint</li>
            <li>New primitives (e.g. affinities)</li>
            <li>Scheduling according to resource constraints</li>
          </ul>
        </section>

        <section>
          <img src="img/carina-topology.png"/>

          <aside class="notes">
            <ul>
              <li>Carina uses Docker Swarm</li>
              <li>Handles the setup and managment</li>
              <li>Segments / Nodes</li>
              <li>This is how we scale</li>
            </ul>
          </aside>
        </section>

        <section>
          <h3>Grow Your Cluster</h3>
          <pre><code class="bash" data-trim data-noescape>
$ <span class="fragment">carina ls</span>
<span class="fragment">ClusterName        Flavor             Segments           AutoScale          Status
mycluster          container1-4G      1                  false              active</span>
<span class="fragment">
$ carina grow --by 1 mycluster</span>
<span class="fragment">ClusterName        Flavor             Segments           AutoScale          Status
mycluster          container1-4G      1                  false              growing</span>
<span class="fragment">
$ carina ls</span>
<span class="fragment">ClusterName        Flavor             Segments           AutoScale          Status
mycluster          container1-4G      2                  false              active</span>
          </code></pre>
        </section>

      <section>
        <pre><code class="bash" data-trim data-noescape>
$ <span class="fragment">docker run --name whoa1 --detach --publish 80:8080 rackerlabs/whoa</span>
<span class="fragment">44aff6801d136ae7ba49ad074d94a7ba94740326f8d9099d7830ec8095abdf72</span>
<span class="fragment">
$ docker port whoa1 8080</span>
<span class="fragment">104.130.0.119:80</span>
<span class="fragment">
$ docker run --name whoa2 --detach --publish 80:8080 rackerlabs/whoa</span>
<span class="fragment">5e0a9815f9558c7a26a44f3bb214f241a5fbf26e01e008739dff64e39c802fce</span>
<span class="fragment">
$ docker port whoa2 8080</span>
<span class="fragment">104.130.0.117:80</span>
<span class="fragment">
$ curl $(docker port whoa1)</span>
<span class="fragment">ðŸŽ‰ Whoa! ðŸŽ‰</span>
        </code></pre>

        <aside class="notes">
          <ul>
            <li>Each segment is a docker host</li>
            <li>Segment IP Address</li>
            <li>Publish to same port across segments</li>
          </ul>
        </aside>
      </section>

      <section>
        <h3>Where does it run?</h3>

        <p>Factors that implicitly influence container placement</p>

        <ul>
          <li><code>--publish</code> finds a node with the published port free</li>
          <li><code>--volumes-from</code> uses the same node as the named container</li>
          <li><code>--link</code> uses the same node aside the named container</li>
        </ul>

        <aside class="notes">
          When Swarm schedules a new container, a number of factors determine which node it places
          the container on. Containers related with these docker arguments will automatically be
          scheduled together.
        </aside>
      </section>

      <section>
        <h3>Constraints and Affinity</h3>

        <p>Explicitly influence where your containers run</p>
        <p>Set by environment variables or build arguments</p>
<pre><code class="bash" data-noescape>
# Run on the same node as another container
$ docker run --env affinity:container==backend ...

# Run on a node where image is available
$ docker run --env affinity:image==myapp ...

# Explicit node name
$ docker run --env constraint:node==6dcd3c04-fab5-4367-ac39-d8b17c41c39c-n1 ...

# Build a new image on the same node as an existing container
$ docker build --build-arg affinity:image==myapp -t myapp:v2 .
</code></pre>

        <aside class="notes">
          Generally speaking, constraints filter on docker daemon attributes, while affinities
          filter on attributes of other containers on each node. You can also use custom container
          metadata labels for lots of control.
        </aside>
      </section>

      <section>
        <h1>Carina</h1>

        <h3>Push Button, Receive Swarm</h3>

        <img src="img/push-button-receive-bacon.jpg"/>

        <aside class="notes">
          With some limitations
        </aside>
      </section>

      <section>
        <h3>Carina Clusters</h3>

        <ul>
          <li>1 to 3 <em>"segments"</em>; LXC containers on a physical host</li>
          <li>20 GB disk space, 4 GB memory, 2 vCPUs per segment</li>
          <li>Each segment has its own public IP, discoverable via <code>docker info</code></li>
        </ul>

        <pre><code class="nohighlight fragment" data-trim data-noescape>
$ docker info
Containers: 9
Images: 13
Role: primary
Strategy: spread
Filters: health, port, dependency, affinity, constraint
Nodes: 3
 6dcd3c04-fab5-4367-ac39-d8b17c41c39c-n1: <mark>172.99.73.138</mark>:42376
  â”” Containers: 3
  â”” Reserved CPUs: 0 / 12
  â”” Reserved Memory: 0 B / 4.2 GiB
  â”” Labels: executiondriver=native-0.2, kernelversion=3.18.21-1-rackos, ...
        </pre></code>

        <aside class="notes">
          Carina segments are for resource control, not geographic redundancy.
        </aside>
      </section>

      <section>
        <h3>Carina Restrictions</h3>
        <ul>
          <li>Volumes only allowed within <code>/var/lib/docker</code></li>
          <li>No <code>--privileged</code> containers or <code>--cap-add</code>/<code>--cap-drop</code></li>
          <li>Limited device access</li>
        </ul>

        <p class="fragment"><em>...but other than that, it's just Swarm</em></p>

        <aside class="notes">
          Mostly these are related to security needs. Prefer using data volume containers to host
          volumes.
        </aside>
      </section>

      <section>
        <h3>Lab</h3>
        <ol>
          <li>Run a <code>rackerlabs/whoa</code> container</li>
          <li>Create a data volume container (DVC) on the same segment</li>
          <li>Use <code>docker cp</code> to upload a self-signed TLS certificate to the DVC</li>
          <li>
            Run an <code>nginx:1.9</code> container that:
            <ul>
              <li>mounts the volume from the DVC</li>
              <li>publishes port 443 and uses your TLS certificate</li>
              <li>proxies traffic to the <code>rackerlabs/whoa</code> container</li>
            </ul>
          </li>
        </ol>
        <hr>
        <ul>
          <li><em>Resources:</em> <a href="https://github.com/everett-toews/jupyterhub-on-docker-swarm/blob/gh-pages/resources/selfsigned.sh"><code>openssl</code>-fu</a> | <a href="https://github.com/everett-toews/jupyterhub-on-docker-swarm/blob/gh-pages/resources/nginx.conf">NGINX configuration template</a></li>
          <li><em>Hint:</em> <code>docker ps</code> will show which segment each container is on</li>
        </ul>
        <aside class="notes">
          <pre><code data-trim class="bash">
docker run -d --name backend rackerlabs/whoa
docker create --name certs -v /certificates -e affinity:container==whoa busybox
docker cp ./private-key.pem certs:/certificates/private-key.pem
docker cp ./public-certificate.pem certs:/certificates/public-certificate.pem
docker build -t my-nginx -f resources/Dockerfile.nginx --build-arg affinity:container==certs resources/
docker run -d --name my-nginx --volumes-from certs -p 443:443 my-nginx
          </code></pre>
        </aside>
      </section>

<!-- ********************************************************************** -->

        <section id="break">
          <h1 style="color:DeepSkyBlue">Break</h1>
        </section>

<!-- ********************************************************************** -->

        <section id="notebook">
          <h1 style="color:DeepSkyBlue">Notebook</h1>
        </section>

        <section>
          <h2>Outline</h2>
          <ul>
            <li>Interactive Literate Coding</li>
            <li>Collaboration</li>
            <li>Visualization</li>
            <li>Rich objects</li>
            <li>Share-able documents</li>
          </ul>
          <aside class="notes">
              The notebook gives you an environment where you can mix and match
              code, prose, and outputs within a document that you can share with
              others
          </aside>
        </section>

        <section>
          <h3>Living Code</h3>
          <img src="img/interactive-notebook.png"></img>
        </section>

        <section>
          <h2>Let's try it live!</h2>
          <h3><a href="https://tmpnb.org">tmpnb.org</a></h3>
        </section>

<!-- ********************************************************************** -->

        <section id="jupyterhub-carina">
          <h1 style="color:DeepSkyBlue">JupyterHub on Carina</h1>
        </section>

        <section>
          <h2>JupyterHub Architecture</h2>
            <ul>
              <li>Notebook servers for users</li>
              <li>Configurable HTTP Proxy</li>
              <li>Bring your own auth</li>
            </ul>
        </section>

        <section>
          <h2>Outline</h2>
          <ul>
            <li>Create a new cluster</li>
            <li>Clone the repo for this preso</li>
            <li>Rely on jupyterhub-launch</li>
          </ul>
        </section>

        <section>
          <h3>Create a new cluster</h3>
          <pre><code data-trim class="bash">
carina create jupyterhub --wait
          </code></pre>
        </section>

<!-- That's one long repo name for the board -->
        <section>
          <h3>Clone this repo</h3>
          <pre><code data-trim class="bash">
git clone https://github.com/everett-toews/jupyterhub-on-docker-swarm
          </code></pre>
        </section>

        <section>
          <h3>Launch</h3>
          <pre><code data-trim class="bash">
cd jupyterhub-on-docker-swarm # if you're not already there
cd jupyterhub-launch
carina env jupyterhub
# TODO: Environment variables, OAauth, Domain
./launch.sh
          </code></pre>
        </section>


<!-- ********************************************************************** -->

        <section id="wrap-up">
          <h1 style="color:DeepSkyBlue">Wrap up</h1>
        </section>

        <section>
          <h1>Thanks!</h1>
          <ul>
            <li><a href="https://rax.io/workshops-feedback" target="_blank">Feedback survey</a></li>
          </ul>
        </section>

<!-- ********************************************************************** -->

      </div>
    </div>

    <script src="lib/js/head.min.js"></script>
    <script src="js/reveal.js"></script>

    <script>

      // Full list of configuration options available at:
      // https://github.com/hakimel/reveal.js#configuration
      Reveal.initialize({
        controls: false,
        slideNumber: 'h/v',
        progress: false,
        history: true,
        center: true,

        transition: 'slide', // none/fade/slide/convex/concave/zoom

        // Optional reveal.js plugins
        dependencies: [
          { src: 'lib/js/classList.js', condition: function() { return !document.body.classList; } },
          { src: 'plugin/markdown/marked.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/markdown/markdown.js', condition: function() { return !!document.querySelector( '[data-markdown]' ); } },
          { src: 'plugin/highlight/highlight.js', async: true, callback: function() { hljs.initHighlightingOnLoad(); } },
          { src: 'plugin/zoom-js/zoom.js', async: true },
          { src: 'plugin/notes/notes.js', async: true }
        ]
      });

    </script>

  </body>
</html>
